generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Podcast {
  id                    String    @id @default(cuid())
  dedupeKey             String    @unique // apple:123456 or web:domain.com|showname

  // Basic Info
  showName              String
  hostName              String?
  showDescription       String?   @db.Text
  websiteUrl            String?
  applePodcastUrl       String?
  spotifyUrl            String?
  primaryPlatformUrl    String

  // Contact Info (with source verification)
  primaryEmail          String?
  primaryEmailSourceUrl String?   // REQUIRED if primaryEmail exists
  backupEmail           String?
  backupEmailSourceUrl  String?   // REQUIRED if backupEmail exists

  // Evidence & Tiering
  tier                  Tier      @default(PENDING)
  tier2Anchor           String?   // General statement about show focus
  tier2EvidenceUrl      String?   // Public evidence supporting anchor
  tier1AddOnLine        String?   // Optional strong connection from transcript
  tier1TranscriptUrl    String?   // Source transcript URL

  // Evidence Collection
  evidenceNotes         String?   @db.Text
  recentEpisodeTitles   String[]  // Last 10 episode titles
  recentGuests          String[]  // Verifiable guests
  transcriptContent     String?   @db.Text // Raw transcript text (for analysis)

  // Stop Rules
  stopRule              StopRule  @default(NONE)
  suppressed            Boolean   @default(false)
  suppressedAt          DateTime?
  suppressionEvidence   String?   @db.Text

  // Outreach Status
  status                OutreachStatus @default(NOT_CONTACTED)

  // Email Draft
  emailDraft            String?   @db.Text
  emailSubject          String?
  selectedAngle         Angle?
  selectedLeadMagnet    String?

  // QA
  qaStatus              QAStatus  @default(NOT_READY)
  qaChecklist           Json?     // { nameCorrect: true, noListeningClaim: true, ... }
  qaApprovedAt          DateTime?
  qaApprovedBy          String?

  // Tracking Dates
  sentPrimaryAt         DateTime?
  followUpSentAt        DateTime?
  sentBackupAt          DateTime?
  replyReceivedAt       DateTime?
  replyType             ReplyType?

  // Calculated Fields
  nextAction            NextAction?
  nextActionDate        DateTime?
  outcome               Outcome   @default(OPEN)

  // Discovery Metadata
  discoverySource       String?   // "seed:guest_name" or "category:fitness"
  discoveryBatch        String?   // "2026-01"
  isNew                 Boolean   @default(true)

  // AI Analysis
  pendingAnalysis       Json?     // Stores AI recommendation before user approval
  analysisRunAt         DateTime? // When analysis was last run

  // Email Finder Results (persisted for retroactive access)
  emailFinderResult     Json?     // Full result with alternates, sources, confidence
  emailFinderRunAt      DateTime? // When email search was last run

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  touches               Touch[]
  notes                 Note[]
}

model Touch {
  id          String    @id @default(cuid())
  podcastId   String
  podcast     Podcast   @relation(fields: [podcastId], references: [id], onDelete: Cascade)

  type        TouchType
  contactUsed String    // Which email was used
  sentAt      DateTime
  emailBody   String    @db.Text
  emailSubject String

  // Gmail tracking (for reply detection)
  gmailMessageId String?   // Gmail message ID returned after send
  gmailThreadId  String?   // Gmail thread ID for tracking replies

  // Response tracking
  opened      Boolean   @default(false)
  openedAt    DateTime?
  replied     Boolean   @default(false)
  repliedAt   DateTime?
  bounced     Boolean   @default(false)
  bouncedAt   DateTime?
  bounceReason String?   // Reason for bounce (if bounced)

  createdAt   DateTime  @default(now())

  @@index([podcastId])
  @@index([gmailThreadId])
}

model Note {
  id          String    @id @default(cuid())
  podcastId   String
  podcast     Podcast   @relation(fields: [podcastId], references: [id], onDelete: Cascade)

  content     String    @db.Text
  author      String    @default("system")

  createdAt   DateTime  @default(now())

  @@index([podcastId])
}

// ============================================
// CONFIGURATION ENTITIES
// ============================================

model SeedGuest {
  id          String    @id @default(cuid())
  name        String
  category    SeedCategory
  notes       String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
}

model LeadMagnet {
  id          String    @id @default(cuid())
  name        String
  description String    @db.Text
  url         String
  matchAngles Angle[]   // Which angles this pairs best with
  ctaSnippet  String    @db.Text // Copy-paste CTA for emails
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
}

model JoeyProfile {
  id                    String    @id @default(cuid())
  positioningStatements String[]
  credibilityAssets     String[]  // "PhD", "Results", etc.
  anglePillars          Angle[]
  allowedTopics         String[]
  noGoTopics            String[]
  personalTraits        String[]  // "dad", "Cuban immigrant", etc.
  connectionHooks       String[]  // Safe things to reference
  safeConnectionStatements String[] // Pre-approved connection lines
  updatedAt             DateTime  @updatedAt
}

model SystemConfig {
  id                    String    @id @default(cuid())

  // Sending Rules
  dailySendCap          Int       @default(10)
  followUpWindowDays    Int       @default(7)
  maxFollowUps          Int       @default(1)
  maxBackupAttempts     Int       @default(1)

  // Discovery Rules
  transcriptEpisodeScope Int      @default(3)  // Check last N episodes

  updatedAt             DateTime  @updatedAt
}

// Quick Categories - customizable search shortcuts for Discovery page
model QuickCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
}

// Perfect Podcast Criteria - defines what makes an ideal podcast target
model PodcastCriteria {
  id          String    @id @default(cuid())

  name        String    // e.g., "Has guest interviews"
  description String?   // Explanation of the criterion
  category    String    @default("general") // general, content, audience, technical

  isEnabled   Boolean   @default(true)
  isRequired  Boolean   @default(false) // Required = instant skip if not met
  isCustom    Boolean   @default(false) // User-added vs system default

  weight      Int       @default(1) // 1-5, how important for scoring

  // For AI prompt generation
  promptHint  String?   // How AI should evaluate this criterion

  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// ENUMS
// ============================================

enum Tier {
  PENDING
  TIER_1      // Strong - transcript evidence
  TIER_2      // Baseline - metadata sufficient
  TIER_3      // Insufficient evidence - no send
}

enum StopRule {
  NONE
  POLITICS
  EXPLICIT
  PAID_GUEST
  FRAUD_PSEUDOSCIENCE
  NO_GUESTS
  TIER_3_INSUFFICIENT
  NO_CONTACT_ROUTE
  BOUNCE
  OPT_OUT
  SPAM_COMPLAINT
}

enum OutreachStatus {
  NOT_CONTACTED
  READY           // Analyzed as good fit, draft ready
  SKIPPED         // Analyzed as not a fit
  READY_TO_DRAFT  // Legacy - keeping for compatibility
  DRAFTED         // Legacy
  QA_APPROVED     // Legacy
  SENT
  FOLLOW_UP_DUE
  FOLLOW_UP_SENT
  ESCALATION_DUE
  ESCALATED
  REPLIED
  CLOSED
}

enum QAStatus {
  NOT_READY
  PENDING_REVIEW
  PASS
  NEEDS_REVISION
}

enum NextAction {
  DRAFT
  QA
  SEND
  FOLLOW_UP
  ESCALATE
  CLOSE
  NONE
}

enum Outcome {
  OPEN
  BOOKED
  DECLINED
  NO_RESPONSE
  SUPPRESSED
  BOUNCED
  OPT_OUT
}

enum ReplyType {
  POSITIVE
  NEUTRAL
  NEGATIVE
  NOT_NOW
  NEEDS_TOPICS
  NEEDS_MEDIA_KIT
  PAID_ONLY
}

enum Angle {
  FAT_LOSS
  GENERAL_HEALTH
  LONGEVITY
  DADS_PARENTING
  CEO_PERFORMANCE
  PERSONAL_DEVELOPMENT
  EVIDENCE_BASED_NUTRITION
  BODY_RECOMPOSITION
}

enum TouchType {
  PRIMARY
  FOLLOW_UP
  BACKUP
}

enum SeedCategory {
  FITNESS_FAT_LOSS
  GENERAL_HEALTH_LONGEVITY
  ENTREPRENEUR_CEO
  DAD_PARENTING
}

// ============================================
// KEY-VALUE STORE FOR CAMPAIGN DATA
// ============================================

// Stores JSON data persistently (for campaigns, settings, etc.)
// This replaces file-based storage which doesn't work on Railway
model KeyValueStore {
  key       String    @id
  value     String    @db.Text  // JSON stored as text
  updatedAt DateTime  @updatedAt
}

// ============================================
// SETTINGS & API KEYS (encrypted storage)
// ============================================

// Stores API keys and settings in the database
// Allows changing keys without redeploying
model Setting {
  id          String    @id @default(cuid())
  key         String    @unique  // e.g., "ANTHROPIC_API_KEY", "ZEROBOUNCE_API_KEY"
  value       String    @db.Text // Encrypted value
  isSecret    Boolean   @default(true)  // If true, value is encrypted
  description String?   // Human-readable description
  category    String    @default("general") // ai, email, discovery, general
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())
}

// ============================================
// RATE LIMITING
// ============================================

// Tracks API request counts for rate limiting
model RateLimit {
  id          String    @id @default(cuid())
  key         String    // IP address, user ID, or API key
  endpoint    String    // API endpoint path (e.g., /api/podcasts)
  count       Int       @default(1)
  windowStart DateTime  @default(now())
  
  @@unique([key, endpoint])
  @@index([windowStart])
}

// ============================================
// GUEST PROFILES
// ============================================

// Stores multiple guest profiles for podcast outreach
model GuestProfile {
  id              String    @id @default(cuid())
  name            String    // Profile display name (e.g., "Business Expert", "Health Coach")
  isActive        Boolean   @default(false) // Only one can be active at a time
  
  // Profile Details
  fullName        String    // Guest's full name
  title           String?   // Job title
  company         String?   // Company name
  bio             String?   @db.Text // Brief bio
  topics          String[]  // Topics they speak about
  credentials     String?   @db.Text // Achievements, social proof
  uniqueAngle     String?   @db.Text // What makes them unique
  
  // Links
  websiteUrl      String?
  linkedinUrl     String?
  twitterUrl      String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
